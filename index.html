<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climbing Video Gallery (API + Upload)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles */
        body { font-family: 'Inter', sans-serif; }
        .filter-button.active { background-color: #3b82f6; color: white; font-weight: bold; }
        .video-item.hidden { display: none; }
        #loading-indicator, #upload-indicator { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.5rem; font-weight: bold; color: #3b82f6; z-index: 100; background-color: rgba(255, 255, 255, 0.8); padding: 1rem 2rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        #loading-indicator.hidden, #upload-indicator.hidden { display: none; }
        /* Style for upload form */
        #upload-form label { display: block; margin-bottom: 0.25rem; font-weight: 500; color: #374151; }
        #upload-form input[type="text"],
        #upload-form input[type="file"] { display: block; width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 0.75rem; font-size: 0.875rem; }
        #upload-form input[type="file"] { padding: 0.3rem; }
        #upload-form .form-actions { display: flex; gap: 0.5rem; margin-top: 1rem; } /* Container for buttons */
        #upload-form button { color: white; padding: 0.6rem 1.2rem; border: none; border-radius: 0.375rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        #upload-button { background-color: #10b981; /* emerald-500 */ }
        #upload-button:hover { background-color: #059669; /* emerald-600 */ }
        #cancel-upload-button { background-color: #6b7280; /* gray-500 */ }
        #cancel-upload-button:hover { background-color: #4b5563; /* gray-600 */ }
        #upload-button:disabled { background-color: #a1a1aa; cursor: not-allowed; } /* zinc-400 */
        #upload-status { margin-top: 1rem; font-weight: 500; }
        .status-success { color: #10b981; } /* emerald-500 */
        .status-error { color: #ef4444; } /* red-500 */
        /* Button to show upload form */
         #show-upload-button { background-color: #3b82f6; /* blue-500 */ color: white; padding: 0.6rem 1.2rem; border: none; border-radius: 0.375rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
         #show-upload-button:hover { background-color: #2563eb; /* blue-600 */ }
    </style>
     <link rel="preconnect" href="https://fonts.googleapis.com">
     <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
     <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="container mx-auto max-w-6xl">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-4">My Climbing Videos</h1>

        <div class="text-center mb-8">
            <button id="show-upload-button">Upload New Video</button>
        </div>

        <div id="upload-section" class="bg-white p-6 rounded-lg shadow-md mb-8 hidden"> <h2 class="text-2xl font-semibold text-gray-700 mb-4">Upload New Video</h2>
            <form id="upload-form">
                <div>
                    <label for="videoTitle">Title:</label>
                    <input type="text" id="videoTitle" name="title" required>
                </div>
                <div>
                    <label for="videoTags">Tags (comma-separated):</label>
                    <input type="text" id="videoTags" name="tags" placeholder="e.g., bouldering, indoor, v5">
                </div>
                 <div>
                    <label for="videoFile">Video File:</label>
                    <input type="file" id="videoFile" name="videoFile" accept="video/*" required>
                 </div>
                 <div class="form-actions">
                     <button type="submit" id="upload-button">Upload Video</button>
                     <button type="button" id="cancel-upload-button">Cancel</button> </div>
            </form>
            <div id="upload-status"></div>
            <div id="upload-indicator" class="hidden">Uploading...</div>
        </div>

        <div id="gallery-section"> <div id="filter-container" class="mb-8 text-center space-y-2 md:space-y-0 md:space-x-2">
                <h2 class="text-xl font-semibold mb-2 text-gray-700">Filter by Tag:</h2>
                <span id="filter-loading" class="text-gray-500">Loading filters...</span>
            </div>

            <div id="video-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                </div>
             <div id="no-results-message" class="text-center text-gray-500 mt-8 hidden">
                No videos match the selected filter.
            </div>
        </div>


        <div id="loading-indicator" class="hidden">Loading Videos...</div>
        <div id="error-message" class="text-center text-red-600 font-semibold mt-8 hidden"></div>
    </div>

    <script>
        // --- Configuration ---
        const API_BASE_URL = 'https://climbing-journal-adhycrchdxffb6br.eastus-01.azurewebsites.net'; // Default for local Flask dev server

        // --- DOM Elements ---
        const filterContainer = document.getElementById('filter-container');
        const filterLoading = document.getElementById('filter-loading');
        const videoGrid = document.getElementById('video-grid');
        const noResultsMessage = document.getElementById('no-results-message');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');
        // Upload elements
        const uploadSection = document.getElementById('upload-section'); // The whole section div
        const gallerySection = document.getElementById('gallery-section'); // The gallery/filter section div
        const showUploadButton = document.getElementById('show-upload-button');
        const cancelUploadButton = document.getElementById('cancel-upload-button');
        const uploadForm = document.getElementById('upload-form');
        const videoTitleInput = document.getElementById('videoTitle');
        const videoTagsInput = document.getElementById('videoTags');
        const videoFileInput = document.getElementById('videoFile');
        const uploadButton = document.getElementById('upload-button');
        const uploadStatus = document.getElementById('upload-status');
        const uploadIndicator = document.getElementById('upload-indicator');


        // --- State ---
        let activeFilter = 'all';
        let allVideosData = [];

        // --- Functions ---

        // Fetch data from API
         async function fetchData(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                if (!response.ok) {
                    let errorData; try { errorData = await response.json(); } catch (e) {}
                    const errorMsg = errorData?.error || `HTTP error! Status: ${response.status}`;
                    throw new Error(errorMsg);
                }
                 const contentType = response.headers.get("content-type");
                 if (contentType && contentType.indexOf("application/json") !== -1) {
                     return await response.json();
                 } else {
                     return await response.text();
                 }
            } catch (error) {
                console.error(`Error fetching ${endpoint}:`, error);
                showError(`API Error: ${error.message}. Please check backend logs.`);
                throw error;
            }
        }

        // Show general error messages
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            loadingIndicator.classList.add('hidden');
            filterLoading.classList.add('hidden');
            uploadIndicator.classList.add('hidden');
        }

        // Clear general error messages
        function clearError() {
            errorMessage.textContent = '';
            errorMessage.classList.add('hidden');
        }

        // Show/hide loading indicator for video list
        function showLoading(show) {
            loadingIndicator.classList.toggle('hidden', !show);
        }

        // Show/hide uploading indicator and disable buttons
        function showUploading(show) {
            uploadIndicator.classList.toggle('hidden', !show);
            uploadButton.disabled = show;
            cancelUploadButton.disabled = show; // Also disable cancel during upload
        }

        // Display status message after upload attempt
        function showUploadStatus(message, isSuccess) {
             uploadStatus.textContent = message;
             // Use className assignment to ensure only status classes are applied
             uploadStatus.className = 'mt-4 font-medium'; // Base classes
             if (isSuccess) {
                uploadStatus.classList.add('status-success');
             } else {
                 uploadStatus.classList.add('status-error');
             }
        }

        // --- UI Toggling Functions ---
        // Show the upload form view
        function showUploadView() {
            uploadSection.classList.remove('hidden');
            gallerySection.classList.add('hidden'); // Hide gallery
            showUploadButton.classList.add('hidden'); // Hide the main upload button
            uploadForm.reset(); // Clear form when shown
            showUploadStatus('', false); // Clear status
            clearError(); // Clear any general errors
        }

        // Show the main gallery view
        function showGalleryView() {
            uploadSection.classList.add('hidden');
            gallerySection.classList.remove('hidden'); // Show gallery
            showUploadButton.classList.remove('hidden'); // Show the main upload button
        }


        // --- Gallery Filtering Functions ---
         async function displayFilterButtons() {
            try {
                filterLoading.classList.remove('hidden');
                const tags = await fetchData('/api/tags');
                filterLoading.classList.add('hidden');
                const heading = filterContainer.querySelector('h2');
                filterContainer.innerHTML = ''; // Clear previous buttons
                if (heading) filterContainer.appendChild(heading); // Re-add heading

                const allButton = createFilterButton('all', 'Show All');
                if (activeFilter === 'all') allButton.classList.add('active');
                filterContainer.appendChild(allButton);

                // Sort tags alphabetically before creating buttons
                tags.sort().forEach(tag => {
                    const button = createFilterButton(tag, tag);
                     if (activeFilter === tag) button.classList.add('active');
                    filterContainer.appendChild(button);
                });
            } catch (error) {
                filterLoading.textContent = 'Error loading filters.';
            }
        }

        // Create a single filter button element
        function createFilterButton(filterValue, buttonText) {
            const button = document.createElement('button');
            button.classList.add(
                'filter-button', 'px-4', 'py-2', 'm-1', 'border', 'border-gray-300',
                'rounded-full', 'text-sm', 'font-medium', 'text-gray-700',
                'bg-white', 'hover:bg-gray-200', 'transition', 'duration-150', 'ease-in-out',
                'capitalize'
            );
            button.dataset.filter = filterValue;
            button.textContent = buttonText;
            button.addEventListener('click', handleFilterClick);
            return button;
        }

        // Handle clicks on filter buttons
         function handleFilterClick(event) {
            const clickedButton = event.target;
            activeFilter = clickedButton.dataset.filter; // Update state first
            // Update button styles immediately
            document.querySelectorAll('.filter-button').forEach(btn => {
                 btn.classList.toggle('active', btn === clickedButton);
            });
            filterVideos(); // Then filter based on new state
        }


        // --- Video Display Functions ---
         async function displayVideos() {
            showLoading(true);
            clearError();
            videoGrid.innerHTML = ''; // Clear grid before loading

            try {
                allVideosData = await fetchData('/api/videos');
                if (!Array.isArray(allVideosData)) {
                     console.error("Received non-array data for videos:", allVideosData);
                     showError("Received invalid video data from server.");
                     allVideosData = [];
                }

                if (allVideosData.length === 0) {
                    noResultsMessage.textContent = "No videos found in the library.";
                    noResultsMessage.classList.remove('hidden');
                } else {
                    noResultsMessage.classList.add('hidden'); // Ensure message is hidden if videos exist
                    allVideosData.forEach(video => addVideoToGrid(video));
                    filterVideos(); // Apply initial/current filter after adding all items
                }
            } catch (error) {
                videoGrid.innerHTML = ''; // Ensure grid is empty on error
            } finally {
                 showLoading(false);
            }
        }

        // Add a single video item to the DOM
        function addVideoToGrid(video) {
             if (!video || typeof video !== 'object') {
                console.error("Attempted to add invalid video data to grid:", video);
                return;
            }
            const videoElement = createVideoItem(video);
            videoGrid.appendChild(videoElement);
        }

        // Create HTML element for a single video
        function createVideoItem(video) {
            const div = document.createElement('div');
            div.classList.add(
                'video-item', 'bg-white', 'rounded-lg', 'shadow-md',
                'overflow-hidden', 'transition-all', 'duration-300', 'ease-in-out'
            );
            const tags = video.tags || [];
            div.dataset.tags = JSON.stringify(tags);
            const videoLink = video.videoUrl || '#';
            const title = video.title || 'Untitled';
            const thumb = video.thumbnail || 'https://placehold.co/600x400/cccccc/1f2937?text=No+Thumb';

            div.innerHTML = `
                <a href="${videoLink}" target="_blank" title="Watch '${title}'">
                    <img src="${thumb}" alt="${title}" class="w-full h-48 object-cover" onerror="this.src='https://placehold.co/600x400/fecaca/1f2937?text=Image+Error'; this.alt='Error loading image'">
                </a>
                <div class="p-4">
                    <h3 class="font-semibold text-gray-800 mb-1 truncate" title="${title}">${title}</h3>
                    <div class="text-xs text-gray-500 space-x-1">
                        ${tags.map(tag => `<span class="inline-block bg-gray-200 rounded-full px-2 py-0.5 capitalize">${tag}</span>`).join(' ')}
                    </div>
                </div>
            `;
            return div;
        }

        // Filter videos currently displayed in the grid
        function filterVideos() {
            let hasVisibleVideos = false;
            const videoItems = videoGrid.querySelectorAll('.video-item');

            // Handle case where grid might be empty but data exists (e.g., before initial render finishes)
            if (videoItems.length === 0 && allVideosData.length === 0) {
                 noResultsMessage.textContent = "No videos found in the library.";
                 noResultsMessage.classList.remove('hidden');
                 return;
            }

            videoItems.forEach(item => {
                const itemTags = JSON.parse(item.dataset.tags || '[]');
                const shouldShow = activeFilter === 'all' || itemTags.includes(activeFilter);
                item.classList.toggle('hidden', !shouldShow);
                if (shouldShow) hasVisibleVideos = true;
            });

            // Update and show/hide the no results message based on visibility and data presence
            noResultsMessage.classList.toggle('hidden', hasVisibleVideos || allVideosData.length === 0);
             if (!hasVisibleVideos && allVideosData.length > 0) {
                 noResultsMessage.textContent = "No videos match the selected filter.";
             } else if (!hasVisibleVideos && allVideosData.length === 0) {
                  noResultsMessage.textContent = "No videos found in the library.";
             }
        }


        // --- Upload Logic ---
        // Handle the form submission for uploading a video
        async function handleUpload(event) {
            event.preventDefault(); // Stop default form submission
            clearError();
            showUploadStatus('', false); // Clear previous status

            const title = videoTitleInput.value.trim();
            const tags = videoTagsInput.value.trim();
            const file = videoFileInput.files[0];

            // Basic validation
            if (!file || !title) {
                showUploadStatus('Title and video file are required.', false);
                return;
            }

            // Prepare form data for sending
            const formData = new FormData();
            formData.append('title', title);
            formData.append('tags', tags); // Backend expects comma-separated string
            formData.append('videoFile', file);

            showUploading(true); // Show indicator, disable buttons

            try {
                // Send data to the backend upload endpoint
                const result = await fetchData('/api/upload', { method: 'POST', body: formData });
                showUploadStatus(result.message || 'Upload successful!', true);

                // Refresh data and switch back to gallery view on success
                await displayVideos(); // Reload all videos from backend
                await displayFilterButtons(); // Reload tags from backend
                showGalleryView(); // Switch view back to the gallery

            } catch (error) {
                 // Error message is already shown by fetchData's catch block
                 // Keep the form visible so the user can see the error and try again
            } finally {
                showUploading(false); // Hide indicator, re-enable buttons
            }
        }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            clearError(); // Clear any errors on load

            // Add event listeners for toggling views
            showUploadButton.addEventListener('click', showUploadView);
            cancelUploadButton.addEventListener('click', showGalleryView);

            // Add event listener for the upload form submission
            uploadForm.addEventListener('submit', handleUpload);

            // Initial load of gallery data
            displayFilterButtons();
            displayVideos();

            // Ensure gallery is shown by default when page loads
            showGalleryView();

        });

    </script>

</body>
</html>
